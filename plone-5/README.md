# Plone

Plone requires the following env vars to run and connect to the postgres backend.

| Env var | Description | Deployed Value |
| --- | ---- | --- |
| POSTGRES_DB | The database name used in postgres | Same as environmen, i.e sandbox/staging/production |
| POSTGRES_USER | The user plone connect to postgres with | `plone`|
| POSTGRES_PASSWORD | The password plone connect to postgres with | A large random string generated by terraform IAC |
| POSTGRES_HOST | The IP address of the database | An internal GCP IP address in the appropriate VPC, named `<env>-db-internal` |

Within a deployment to envionment buld pipleine everything bar `POSTGRES_USER` needs to be set using a docker `--build-arg`.

## Running plone locally with PostgresDB

When run in an environment Plone uses a postgres database hosted on cloudsql.

To create this locally, you need to...

### 1. Run postgres locally

Export the following environment variables, the others have a viable default.

| Env var | Description |
| --- | ---- |
| POSTGRES_USER | Should be `plone`|
| POSTGRES_DB | Should be `local` |
| POSTGRES_PASSWORD | Up to you, pick something sensible for local devlopment. |

Then run postgres with docker.

```
docker run --name plone-postgres -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD -d -p 5432:5432 postgres:14
```

notes:
- the `--name` here is just the name of the docker container we're creating, it has nothing to do with the DB connection.
- its `postgres:14` as that's what CloudSQL is using at time of writing, you can check this via the CloudSQL page in the GCP console.


### 2. Import a representative data backup from GCP

Download the desired backup from the google bucket `cms-sql-backup`.

Import the SQL into your locally running postgres instance via:

```
docker exec -i plone-postgres psql -U $POSTGRES_USER -d $POSTGRES_DB < <PATH_TO_DOWNLOADED_SQL_DUMP>.sql
```

_Note - you will get warnings for missing "cloudql-*" roles but it still works._

### 3. Run plone locally with docker

build the image (from this directory).

```
docker -t plone build . 
```

run it

```
docker run --build-arg POSTGRES_PASSWORD=$POSTGRES_PASSWORD -p 8080:8080 plone
```

**Important** - there's no oauth handler set up for localhost, you'll need to log into your zope user (for whatever env you copied the database from) to bypass this broken handshake.

Any issues, you can sanity check what's been set in the `zope,conf` (by the dockerfile) via:

```
docker run -it -e POSTGRES_PASSWORD=$POSTGRES_PASSWORD -p 8080:8080 plone /bin/sh

# then
cat /plone/instance/parts/instance/etc/zope.conf

# then exit to leave container.
```
