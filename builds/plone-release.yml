steps:

  - name: 'gcr.io/kaniko-project/executor:latest'
    args:
      - >-
        --destination=${_IMAGE_REPOSITORY}/plone:latest-release
      - >-
        --destination=${_IMAGE_REPOSITORY}/plone:$TAG_NAME
      - >-
        --context=dir://plone-5

  # This uses the kubectl runner (a container designed to interact
  # with k8s via kubectl) to update the image defined in the k8s deployment
  # on the cluster in question - k8s will notice this and green/blue 
  # bounce the pod(s) from there.
  - name: gcr.io/cloud-builders/kubectl
    env:
      - CLOUDSDK_COMPUTE_REGION=${_REGION}
      - CLOUDSDK_CONTAINER_CLUSTER=${_K8S_CLUSTER_NAME}
    args:
      - set
      - image
      - deployment/plone
      - '--namespace=cms'
      - >-
        plone=${_IMAGE_REPOSITORY}/plone:$TAG_NAME
timeout: 7200s  # 2 hours !!
options:
  machineType: E2_HIGHCPU_32